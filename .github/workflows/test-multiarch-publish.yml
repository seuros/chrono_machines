name: Test Multi-Arch Build & GitHub Packages Publishing

on:
  workflow_dispatch:
    inputs:
      test_version_suffix:
        description: 'Version suffix for test gem (e.g., test1, alpha1)'
        required: true
        default: 'test1'
      publish_to_github_packages:
        description: 'Publish to GitHub Packages (or just build)'
        required: true
        type: boolean
        default: false
      dry_run_publish:
        description: 'Dry-run publish (validate auth without actually publishing)'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  packages: write

jobs:
  build-test-gem:
    runs-on: ubuntu-latest
    outputs:
      gem_version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Get current version and create test version
        id: version
        run: |
          VERSION=$(ruby -e "require './lib/chrono_machines/version'; puts ChronoMachines::VERSION")
          TEST_VERSION="${VERSION}.${{ inputs.test_version_suffix }}"
          # RubyGems normalizes version format, so we need to check what it will actually be
          NORMALIZED_VERSION=$(ruby -e "require 'rubygems'; puts Gem::Version.new('${TEST_VERSION}').to_s")
          echo "version=${TEST_VERSION}" >> "$GITHUB_OUTPUT"
          echo "normalized_version=${NORMALIZED_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building test version: ${TEST_VERSION} (normalized: ${NORMALIZED_VERSION})"

      - name: Update version for test build
        run: |
          sed -i.bak "s/VERSION = '[^']*'/VERSION = '${{ steps.version.outputs.version }}'/" lib/chrono_machines/version.rb
          rm lib/chrono_machines/version.rb.bak

      - name: Build test gem
        env:
          GEM_PUSH_HOST: https://rubygems.pkg.github.com/${{ github.repository_owner }}
        run: bundle exec rake build

      - name: Verify gem was built
        run: |
          ls -lh pkg/
          # Check for the gem file - RubyGems may normalize the version
          EXPECTED_FILE="pkg/chrono_machines-${{ steps.version.outputs.normalized_version }}.gem"
          if [ ! -f "$EXPECTED_FILE" ]; then
            echo "::error::Expected gem file not found: $EXPECTED_FILE"
            echo "Files in pkg/:"
            ls -la pkg/
            exit 1
          fi
          echo "✓ Found expected gem: $EXPECTED_FILE"

      - name: Upload test gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-ruby-gem
          path: pkg/*.gem
          if-no-files-found: error

  build-native-gems:
    runs-on: ubuntu-latest
    needs: build-test-gem
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Existing platforms (working)
          - arm64-darwin
          - x86_64-darwin
          - x86_64-linux
          # New musl platform
          - x86_64-linux-musl
          # Note: aarch64-linux excluded due to cache corruption issues in test workflow
          # It works in release-please.yml, so we'll add it there directly
    steps:
      - uses: actions/checkout@v6

      - name: Update version for test build
        run: |
          sed -i.bak "s/VERSION = '[^']*'/VERSION = '${{ needs.build-test-gem.outputs.gem_version }}'/" lib/chrono_machines/version.rb
          rm lib/chrono_machines/version.rb.bak

      - name: Configure gem installation directory
        run: |
          GEM_HOME="$HOME/.gem"
          mkdir -p "$GEM_HOME/bin"
          echo "GEM_HOME=$GEM_HOME" >> "$GITHUB_ENV"
          echo "GEM_PATH=$GEM_HOME" >> "$GITHUB_ENV"
          echo "$GEM_HOME/bin" >> "$GITHUB_PATH"

      - name: Cross-compile native gem
        id: cross
        uses: oxidize-rb/actions/cross-gem@v1
        env:
          GEM_PUSH_HOST: https://rubygems.pkg.github.com/${{ github.repository_owner }}
        with:
          platform: ${{ matrix.platform }}
          ruby-versions: '3.4'

      - name: Verify native gem was built
        run: |
          echo "Gem path: ${{ steps.cross.outputs.gem-path }}"
          if [ ! -f "${{ steps.cross.outputs.gem-path }}" ]; then
            echo "::error::Native gem not found at expected path"
            exit 1
          fi
          ls -lh "${{ steps.cross.outputs.gem-path }}"

      - name: Upload platform gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-native-gem-${{ matrix.platform }}
          path: ${{ steps.cross.outputs.gem-path }}
          if-no-files-found: error

  smoke-test:
    runs-on: ubuntu-latest
    needs:
      - build-test-gem
      - build-native-gems
    continue-on-error: true  # Don't fail workflow if smoke tests fail
    strategy:
      fail-fast: false
      matrix:
        platform:
          - x86_64-linux
          - x86_64-linux-musl
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: test-native-gem-${{ matrix.platform }}
          path: gems

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'

      - name: Install dependencies
        run: |
          # Install dependencies from rubygems.org first
          gem install zeitwerk -v "~> 2.7" --no-document

      - name: Test gem installation
        run: |
          GEM_FILE=$(ls gems/*.gem)
          echo "Testing installation of: $GEM_FILE"
          gem install "$GEM_FILE" --ignore-dependencies --no-document

      - name: Verify native extension loaded
        run: |
          ruby -e "
            require 'chrono_machines'
            puts 'Gem loaded successfully'
            # Try to load native backend
            begin
              require 'chrono_machines_native'
              puts 'Native backend available'
            rescue LoadError
              puts 'Native backend not available (fallback to pure Ruby)'
            end
          "

  smoke-test-musl:
    runs-on: ubuntu-latest
    needs:
      - build-test-gem
      - build-native-gems
    continue-on-error: true  # Don't fail workflow if smoke tests fail
    container:
      image: ruby:3.4-alpine
    strategy:
      fail-fast: false
      matrix:
        platform:
          - x86_64-linux-musl
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: test-native-gem-${{ matrix.platform }}
          path: gems

      - name: Install dependencies on Alpine
        run: |
          # Install dependencies from rubygems.org first
          gem install zeitwerk -v "~> 2.7" --no-document

      - name: Test gem installation on Alpine
        run: |
          GEM_FILE=$(ls gems/*.gem)
          echo "Testing musl gem on Alpine: $GEM_FILE"
          gem install "$GEM_FILE" --ignore-dependencies --no-document

      - name: Verify no glibc linkage
        run: |
          ruby -e "
            require 'chrono_machines'
            puts 'Gem loaded successfully on Alpine (musl)'
            begin
              require 'chrono_machines_native'
              puts 'Native musl backend loaded successfully'
            rescue LoadError => e
              puts 'ERROR: Native backend failed to load on musl'
              puts e.message
              exit 1
            end
          "

  publish-to-github-packages:
    needs:
      - build-test-gem
      - build-native-gems
      - smoke-test
      - smoke-test-musl
    if: ${{ inputs.publish_to_github_packages }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'

      - name: Download all gem artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List all artifacts
        run: |
          echo "=== All artifacts ==="
          find artifacts -name "*.gem" -type f
          echo ""
          echo "=== Gem details ==="
          find artifacts -name "*.gem" -type f -exec ls -lh {} \;

      - name: Setup gem credentials
        run: |
          mkdir -p ~/.gem
          cat << EOF > ~/.gem/credentials
          ---
          :github: Bearer ${{ secrets.GITHUB_TOKEN }}
          EOF
          chmod 0600 ~/.gem/credentials

      - name: Publish gems to GitHub Packages
        run: |
          DRY_RUN="${{ inputs.dry_run_publish }}"
          OWNER="${{ github.repository_owner }}"
          HOST="https://rubygems.pkg.github.com/${OWNER}"

          echo "Publishing to: ${HOST}"

          for gem in artifacts/**/*.gem; do
            echo ""
            echo "Processing: $gem"

            if [ "$DRY_RUN" = "true" ]; then
              echo "[DRY RUN] Would publish: $gem"
              gem push --key github --host "${HOST}" "$gem" --dry-run || true
            else
              echo "Publishing: $gem"
              gem push --key github --host "${HOST}" "$gem" 2>&1 | tee /tmp/push.log
              EXIT_CODE=$?

              if [ $EXIT_CODE -eq 0 ]; then
                echo "✓ Successfully pushed $gem"
              elif grep -q "already been pushed" /tmp/push.log; then
                echo "⊘ Skipping $gem (already published)"
              else
                echo "✗ Failed to push $gem"
                cat /tmp/push.log
                exit 1
              fi
            fi
          done

      - name: Cleanup credentials
        if: always()
        run: rm -f ~/.gem/credentials

  summary:
    needs:
      - build-test-gem
      - build-native-gems
      - smoke-test
      - smoke-test-musl
      - publish-to-github-packages
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Test Summary
        run: |
          echo "## Multi-Architecture Build Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Version:** ${{ needs.build-test-gem.outputs.gem_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms Built:** 4 (3 existing + 1 musl)" >> $GITHUB_STEP_SUMMARY
          echo "**Published:** ${{ inputs.publish_to_github_packages }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run_publish }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Supported Platforms" >> $GITHUB_STEP_SUMMARY
          echo "- **arm64-darwin** (Apple Silicon macOS)" >> $GITHUB_STEP_SUMMARY
          echo "- **x86_64-darwin** (Intel macOS)" >> $GITHUB_STEP_SUMMARY
          echo "- **x86_64-linux** (Linux glibc)" >> $GITHUB_STEP_SUMMARY
          echo "- **x86_64-linux-musl** (Alpine Linux)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Review artifacts in this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Test gem installation from GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ If successful, integrate into release workflow" >> $GITHUB_STEP_SUMMARY
